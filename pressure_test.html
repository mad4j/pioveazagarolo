<!DOCTYPE html>
<html>
<head>
    <title>Pressure Chart Delta Alignment Test</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .chart-container { width: 600px; height: 300px; margin: 20px 0; border: 1px solid #ccc; }
        .scenario { margin-bottom: 40px; }
    </style>
</head>
<body>
    <h1>Pressure Chart Delta Bar Alignment Test</h1>
    <p>This demonstrates the fix for centering delta bars on the 1013 hPa reference line.</p>
    
    <div class="scenario">
        <h3>Scenario 1: Normal pressure around 1013 hPa</h3>
        <div class="chart-container">
            <canvas id="chart1"></canvas>
        </div>
    </div>
    
    <div class="scenario">
        <h3>Scenario 2: High pressure range (1025-1035 hPa)</h3>
        <div class="chart-container">
            <canvas id="chart2"></canvas>
        </div>
    </div>
    
    <div class="scenario">
        <h3>Scenario 3: Low pressure range (995-1005 hPa)</h3>
        <div class="chart-container">
            <canvas id="chart3"></canvas>
        </div>
    </div>

    <script>
        // Plugin to draw 1013 hPa reference line
        const reference1013Plugin = {
            id: 'reference1013',
            afterDraw(chart, args, opts) {
                const yScale = chart.scales.y;
                if (!yScale) return;
                
                const y = yScale.getPixelForValue(1013);
                const { left, right } = chart.chartArea;
                const ctx = chart.ctx;
                
                ctx.save();
                ctx.strokeStyle = '#27ae60';
                ctx.lineWidth = 2;
                ctx.setLineDash([8, 4]);
                ctx.beginPath();
                ctx.moveTo(left, y);
                ctx.lineTo(right, y);
                ctx.stroke();
                ctx.restore();
            }
        };
        
        function buildTestPressureChart(canvasId, pressureData, title) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            // Calculate pressure deltas (pressure - 1013)
            const pressureDeltas = pressureData.map(pressure => pressure - 1013);
            const deltasColors = pressureDeltas.map(delta => delta > 0 ? 'rgba(231, 76, 60, 0.7)' : 'rgba(52, 152, 219, 0.7)');
            
            // Calculate scale to ensure 1013 hPa is visible but not necessarily centered
            const dataMin = Math.min(...pressureData);
            const dataMax = Math.max(...pressureData);
            const referencePoint = 1013;
            
            // Calculate natural data range with padding
            const dataRange = dataMax - dataMin;
            const basePadding = Math.max(dataRange * 0.15, 3); // 15% padding or minimum 3 hPa
            
            // Start with natural data bounds plus padding
            let minPressure = dataMin - basePadding;
            let maxPressure = dataMax + basePadding;
            
            // Ensure 1013 hPa reference line is visible within the chart
            if (referencePoint < minPressure) {
                // 1013 is below the current range, extend downward
                minPressure = referencePoint - basePadding;
            } else if (referencePoint > maxPressure) {
                // 1013 is above the current range, extend upward  
                maxPressure = referencePoint + basePadding;
            }
            
            // Ensure minimum range for chart readability
            const finalRange = maxPressure - minPressure;
            if (finalRange < 10) {
                const center = (minPressure + maxPressure) / 2;
                minPressure = center - 5;
                maxPressure = center + 5;
            }
            
            // Calculate delta scale range - center delta bars on 1013 hPa line
            const maxDelta = Math.max(...pressureDeltas.map(Math.abs));
            const deltaRange = Math.max(maxDelta, 5); // Minimum range of 5 hPa
            
            // Calculate where 1013 hPa falls in the pressure scale (as a fraction from 0 to 1)
            const pressurePosition = (referencePoint - minPressure) / (maxPressure - minPressure);
            
            // Adjust delta scale so that 0 (zero delta) aligns with 1013 hPa position
            const minDelta = -pressurePosition * 2 * deltaRange;
            const maxDeltaValue = (1 - pressurePosition) * 2 * deltaRange;
            
            console.log(`${title}: Pressure position = ${pressurePosition.toFixed(3)}, Delta zero position should match`);
            
            return new Chart(ctx, {
                plugins: [reference1013Plugin],
                data: {
                    labels: Array.from({length: pressureData.length}, (_, i) => `${i}:00`),
                    datasets: [
                        {
                            label: 'Pressione (hPa)',
                            type: 'line',
                            fill: false,
                            tension: 0.4,
                            backgroundColor: 'rgb(142, 68, 173)',
                            borderColor: 'rgb(142, 68, 173)',
                            borderWidth: 2,
                            data: pressureData,
                            pointRadius: 3,
                            yAxisID: 'y',
                            order: 1
                        },
                        {
                            label: 'Delta Pressione (hPa)',
                            type: 'bar',
                            backgroundColor: deltasColors,
                            borderColor: deltasColors,
                            borderWidth: 0,
                            data: pressureDeltas,
                            yAxisID: 'y1',
                            order: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: title
                        },
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            min: minPressure,
                            max: maxPressure,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Pressure (hPa)'
                            }
                        },
                        y1: {
                            min: minDelta,
                            max: maxDeltaValue,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Delta from 1013 hPa'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Hour'
                            }
                        }
                    }
                }
            });
        }
        
        // Test scenarios
        const scenario1 = [1010, 1012, 1013, 1015, 1016, 1014, 1013, 1011];
        const scenario2 = [1025, 1027, 1030, 1032, 1035, 1033, 1031, 1028];
        const scenario3 = [995, 998, 1000, 1002, 1005, 1003, 1001, 997];
        
        buildTestPressureChart('chart1', scenario1, 'Normal pressure (1013 roughly centered)');
        buildTestPressureChart('chart2', scenario2, 'High pressure (1013 at bottom, delta bars should extend upward from 1013 line)');
        buildTestPressureChart('chart3', scenario3, 'Low pressure (1013 at top, delta bars should extend downward from 1013 line)');
    </script>
</body>
</html>